<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta http-equiv="X-UA-Compatible" content="ie=edge">
   <link rel="stylesheet" type="text/css" href="../site/style.css" />
   <script type="text/javascript" src="../site/global.js"></script> 
   <script>window.onload = function(){ // load global variables
               document.getElementById('g_teach').innerHTML           = g.n04 + " " + g.teach;
            //    document.getElementById('g_teachTime').innerHTML       = g.teachTime;
            //    document.getElementById('g_teachInstructor').innerHTML = g.teachInstructor;
            //    document.getElementById('g_teachSolution').innerHTML   = g.teachSolution;
               document.getElementById('g_teachSubmit').innerHTML     = g.teachSubmit;}
   </script> 
</head>
<body>
    <iframe src= "../site/header.html" class="headerIframe"></iframe>
    <article>
        <h1><span id="g_teach"></span></h1>

        <h2>Overview</h2>
        <p>Your team activity this week is extremely simple. <strong>Once you all have completed the reading</strong>, assist one another in making some modifications to your apps for MongoDB compatability with Heroku. Please read the instructions below:</p>
         <h3>Using MongoDB on Heroku</h3>
        <p>
          In order to manage the use of external services and ports, Heroku's architecture requires the use of 
          <a href="https://devcenter.heroku.com/articles/config-vars" target="_blank">config vars</a>.</br>
          For example, for your app to run on both Heroku and localhost, Express calls .listen(PORT), which makes use of 
          of the Heroku config var, .</br> 
          PORT is initialized with:
            <code class="bash hljs">const PORT = process.env.PORT || 5000</code> 
          Using the ||, PORT's value is initialized to the first defined variable.</p> 
          <p>So, when the application is run on Heroku, <code>process.env.PORT</code>
          is defined and passed to .listen(). Running locally, the config var is undefined, so the localhost port 5000 is passed to .listen() instead.</br>
          A similar process must be used for the MongoDB implementation you created using the online video course.
        </p>
        <h2>Preparation Material</h2>
        <ol>
            <li>
                <p>First, you will need to install the <a href="https://www.npmjs.com/package/cors" target="_blank">cors node package</a> using npm in your terminal:</p>
                <code class="bash hljs">npm install cors</code>
                <p>We'll use this package later.</p>
            </li>
            <li>
                <p>Next, open and login to <a href="https://cloud.mongodb.com/" target="_blank">MongoDB Atlas dashboard</a> on your browser, and click "Network Access"
                    under the Security tab.</p>
                <p>Click the "+ ADD IP ADDRESS" button, and add the following IP address to the whitelist:</p>
                <img src="images/whitelist_form.png" class="img-tutorial">
                <p>This will allow all those who access your Heroku site to use the database. It's not very secure right now, but that's ok.</p>
            </li>
            <li>
                <p>Within your <a href="https://cloud.mongodb.com/" target="_blank">MongoDB Atlas dashboard</a>, click on the clusters tab below "Data Storage"</p>
                <p>Click on "connect" within the cluster you created for your shop</p>
                <p>In the popup, click on "Connect your application"</p>
                <p>Click the "Copy" button the "Connection String Only" tab beneath step 2:</p>
                <img src="images/atlas_connection.png" class="img-tutorial">
            </li>
            <li>
                <p>Navigate to your app's settings in the <a href="https://dashboard.heroku.com/apps" target="_blank">Heroku dashboard</a></p>
                <p>Click the app that you've published your store app to, and click on "settings"</p>
                <p>Beneath settings, find the "Config Vars" section and click "Reveal Config Vars"</p>
                <img src="images/config_vars_1.png" class="img-tutorial">
                <p>Now, using the connection string you copied from your MongoDB Atlas cluster, enter a keyname of <code>MONGODB_URL</code>
                    and with the value as your connection string.
                </p>
                <p>Obviously, &ltusername&gt and &ltpassword&gt should contain your MongoDB username and password.</p>
                <img src="images/new_config_var.png" class="img-tutorial">
                <p>Click add when the correct values are placed.</p>
            </li>
            <li>
                <p>Finally, within your app.js or index.js file (or wherever else you decided to place your Mongoose setup), add the 
                    following lines of code:</p>
                    <pre>
                        <code class="hljs">
const cors = <span class="hljs-function">require</span>(<span class="hljs-string">'cors'</span>) <span class="hljs-comment">// Place this with other requires (like 'path' and 'express')</span>
...
const corsOptions = {
    origin: <span class="hljs-string">"https://&ltyour_app_name&gt.herokuapp.com/"</span>,
    optionsSuccessStatus: <span class="hljs-number">200</span>
};
app.use(<span class="hljs-function">cors</span>(corsOptions));

const options = {
    useUnifiedTopology: <span class="hljs-value">true</span>,
    useNewUrlParser: <span class="hljs-value">true</span>,
    useCreateIndex: <span class="hljs-value">true</span>,
    useFindAndModify: <span class="hljs-value">false</span>,
    family: <span class="hljs-number">4</span>
};

const MONGODB_URL = process.env.MONGODB_URL || <span class="hljs-string">"mongodb+srv://&ltusername&gt:&ltusername&gt@cse341cluster-3dwlw.mongodb.net/test?retryWrites=true&w=majority"</span>;
                        </code>
                    </pre>
                <p>Finally, modify your mongoose.connect() function to match this:</p>
                <pre>
                    <code class="hljs">
mongoose
  .connect(
    MONGODB_URI, options
  )
  .then(result => {
    ... <span class="hljs-comment">// This should be your user handling code implement following the course videos</span>
    app.listen(PORT);
  })
  .catch(err => {
    console.log(err);
  });

                    </code>
                </pre>
            </li>
            <li><p>Finally, push your application to Heroku master and check if your app works on Heroku.</p></li>
        </ol>
    <h2>Conclusion</h2>
    <p>If you ever have any questions or issues, make sure to look at your Heroku logs with <code>Heroku logs --tail</code> and search online for solutions before seeking help in the class. If you find helpful resources or tutorials as you configure your project this week, please post them in the help channel to help your peers.</p>
    </article>
</body>
</html>
